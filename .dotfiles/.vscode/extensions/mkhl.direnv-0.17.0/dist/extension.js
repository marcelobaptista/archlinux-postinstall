"use strict";var K=Object.create;var g=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,Z=Object.prototype.hasOwnProperty;var _=(n,e)=>{for(var t in e)g(n,t,{get:e[t],enumerable:!0})},S=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of X(e))!Z.call(n,a)&&a!==t&&g(n,a,{get:()=>e[a],enumerable:!(i=Q(e,a))||i.enumerable});return n};var c=(n,e,t)=>(t=n!=null?K(Y(n)):{},S(e||!n||!n.__esModule?g(t,"default",{value:n,enumerable:!0}):t,n)),ee=n=>S(g({},"__esModule",{value:!0}),n);var le={};_(le,{activate:()=>pe,deactivate:()=>he});module.exports=ee(le);var w=c(require("path")),r=c(require("vscode"));var T=c(require("crypto")),l=class{hash=T.default.createHash("sha1");update(e,t){return this.hash.update(`${e}=${t??""}
`),this}digest(){return this.hash.digest("base64url")}};var k=c(require("vscode")),te="direnv",y=class{constructor(e){this.value=e}};function O(n,e){return e.affectsConfiguration(n.join("."))}async function P(n){await k.default.commands.executeCommand("workbench.action.openSettings",n.join("."))}function f(n){return new y(n)}function ne(n,e){return{get(){let[t,...i]=n;return k.default.workspace.getConfiguration(t).get(i.join("."))??e.value},isAffectedBy(t){return O(n,t)},open(){return P(n)}}}function L(n,e){return{isAffectedBy(t){return O(n,t)},open(){return P(n)},...Object.fromEntries(Object.entries(e).map(([t,i])=>[t,i instanceof y?ne([...n,t],i):L([...n,t],i)]))}}var s=L([te],{extraEnv:f({}),watchForChanges:f(!0),path:{executable:f("direnv")},status:{showChangesCount:f(!0)},restart:{automatic:f(!1)}});var A=c(require("child_process")),F=c(require("os")),N=require("util"),W=c(require("vscode")),R=c(require("zlib"));var ie=(0,N.promisify)(A.default.execFile),m=class extends Error{constructor(t,i){super(`${t} is blocked`);this.path=t;this.data=i}},v=class extends Error{constructor(t){super(`${t}: command not found`);this.path=t}};function I(n){return typeof n!="object"||n===null?!1:"stdout"in n&&"stderr"in n}function re(n,e){return!(n instanceof Error)||!("path"in n)||!("code"in n)?!1:n.path===e&&n.code==="ENOENT"}var M={EDITOR:"echo"};function u(){var n;return((n=W.default.workspace.workspaceFolders)==null?void 0:n[0].uri.fsPath)??F.default.homedir()}async function p(n,e,t){let i={encoding:"utf8",cwd:t??u(),env:{...process.env,TERM:"dumb",...e,...s.extraEnv.get()}},a=s.path.executable.get();try{return await ie(a,n,i)}catch(o){throw re(o,a)?new v(a):o}}async function U(){await p(["version"])}async function j(n){await p(["allow",n])}async function V(n){await p(["deny",n])}async function C(){let{stdout:n}=await p(["edit",u()],M);return n.trimEnd()}async function H(){try{let{stdout:n}=await p(["edit"],M);return n.trimEnd()}catch(n){if(I(n)&&/direnv: error (?<path>.+) not found./.exec(n.stderr))return C();throw n}}async function J(n){var e;try{let{stdout:t}=await p(["export","json"],void 0,n);return B(t)}catch(t){if(I(t)){let i=/direnv: error (?<path>.+) is blocked./.exec(t.stderr);if((e=i==null?void 0:i.groups)!=null&&e.path)throw new m(i.groups.path,B(t.stdout,b))}throw t}}function B(n,e=()=>!0){if(!n)return new Map;let t=JSON.parse(n);return new Map(Object.entries(t).filter(([i])=>e(i)))}function b(n){return n.startsWith("DIRENV_")}function z(n){return n===void 0?[]:(ae(n.get("DIRENV_WATCHES"))??[]).map(t=>t.path??t.Path).filter(t=>!!t)}function ae(n){if(!n)return;let e=Buffer.from(n,"base64url"),i=R.default.inflateSync(e).toString("utf8");return JSON.parse(i)}var q=c(require("path"));var d=class n{constructor(e,t,i,a=()=>this){this.text=e;this.tooltip=t;this.command=i;this.refresh=a}static loading=new n("$(folder)$(sync~spin)","direnv loading\u2026");static empty=new n("$(folder)",`direnv empty
Create\u2026`,"direnv.create");static loaded(e){let t="$(folder-active)",i=[`direnv loaded: ${e.added} added, ${e.changed} changed, ${e.removed} removed`];if(e.currentFolder){let a=q.default.relative(u(),e.currentFolder);a&&(t+=` ${a}`,i.push(`in: ${a}`))}return s.status.showChangesCount.get()&&(t+=` +${e.added}/~${e.changed}/-${e.removed}`),i.push("Reload\u2026"),new n(t,i.join(`
`),"direnv.reload",()=>n.loaded(e))}static blocked(e){return new n("$(folder)$(shield)",`direnv blocked: ${e}
Review\u2026`,"direnv.open",()=>n.blocked(e))}static failed=new n("$(folder)$(flame)",`direnv failed
Reload\u2026`,"direnv.reload")},E=class{constructor(e){this.item=e;e.text=d.empty.text,e.show()}state=d.empty;dispose(){this.item.dispose()}update(e){this.state=e,this.item.text=e.text,this.item.tooltip=e.tooltip,this.item.command=e.command}refresh(){this.update(this.state.refresh())}};var de=r.default.Uri.parse("https://direnv.net/docs/installation.html"),x=class{constructor(e,t){this.context=e;this.status=t;this.willLoad.event(()=>this.onWillLoad()),this.didLoad.event(i=>this.onDidLoad(i)),this.loaded.event(()=>this.onLoaded()),this.failed.event(i=>this.onFailed(i)),this.blocked.event(i=>this.onBlocked(i)),this.viewBlocked.event(i=>this.onViewBlocked(i)),this.didUpdate.event(()=>this.onDidUpdate())}output=r.default.window.createOutputChannel("direnv");backup=new Map;willLoad=new r.default.EventEmitter;didLoad=new r.default.EventEmitter;loaded=new r.default.EventEmitter;failed=new r.default.EventEmitter;blocked=new r.default.EventEmitter;viewBlocked=new r.default.EventEmitter;didUpdate=new r.default.EventEmitter;blockedPath;cwdOverride;watchers=r.default.Disposable.from();get environment(){return this.context.environmentVariableCollection}get cache(){return this.context.workspaceState}dispose(){this.output.dispose(),this.status.dispose(),this.watchers.dispose()}async allow(e){await this.try(async()=>{await j(e),this.willLoad.fire()})}async block(e){await this.try(async()=>{await V(e),this.willLoad.fire()})}didOpen(e){this.blockedPath===e&&this.viewBlocked.fire(e)}async configurationChanged(e){s.isAffectedBy(e)&&((s.path.isAffectedBy(e)||s.extraEnv.isAffectedBy(e))&&await this.reload(),s.status.isAffectedBy(e)&&this.status.refresh())}async create(){await this.open(await C())}async open(e){e??=await H();let t=await ue(e);await r.default.commands.executeCommand("vscode.open",t),this.didOpen(e)}async loadEnvrc(e){if(!e){let t={canSelectFiles:!0,canSelectFolders:!1,canSelectMany:!1,defaultUri:r.default.Uri.file(u()),filters:{".envrc":["envrc"]},openLabel:"Load",title:"Select .envrc to load"},i=await r.default.window.showOpenDialog(t);if(i===void 0||i.length!==1)return;e=i[0]}if(w.default.basename(e.path)!==".envrc"){await r.default.window.showErrorMessage("direnv: Not a .envrc!");return}this.cwdOverride=w.default.dirname(e.path),this.willLoad.fire()}async reload(){await this.resetCache(),await this.load()}async reset(){this.resetEnvironment(),await this.resetCache(),await this.load()}restore(){let e=this.restoreCache();this.updateEnvironment(e),this.load()}restoreCache(){this.cwdOverride=this.cache.get("direnv.cwdOverride");let e=this.cache.get("direnv.checksum");if(e===void 0)return;let t=this.cache.get("direnv.environment");if(!Array.isArray(t))return;let i=new Map(t.map(([o,h])=>[o,h??null])),a=new l;for(let[o]of i)a.update(o,process.env[o]);if(e===a.digest())return i}async updateCache(){let e=new l,t=[];for(let[i,a]of this.backup)e.update(i,a),t.push([i,process.env[i]]);await this.cache.update("direnv.checksum",e.digest()),await this.cache.update("direnv.environment",t),await this.cache.update("direnv.cwdOverride",this.cwdOverride)}async resetCache(){await this.cache.update("direnv.environment",void 0),await this.cache.update("direnv.cwdOverride",void 0)}createWatcher(e){let t=w.default.dirname(e),i=w.default.basename(e),a=new r.default.RelativePattern(r.default.Uri.file(t),i),o=r.default.workspace.createFileSystemWatcher(a);return o.onDidChange(()=>this.reload()),o.onDidCreate(()=>this.reload()),o.onDidDelete(()=>this.reload()),this.output.appendLine(`watching: ${e}`),o}updateWatchers(e){this.watchers.dispose(),s.watchForChanges.get()&&(this.watchers=r.default.Disposable.from(...z(e).map(t=>this.createWatcher(t))))}updateEnvironment(e){if(e!==void 0&&e.size!==0){for(let[t,i]of e)this.backup.has(t)||this.backup.set(t,process.env[t]),this.updateTerminalEnv(t,i),this.updateProcessEnv(t,i);this.updateWatchers(e)}}resetEnvironment(e){for(let[t,i]of this.backup)this.updateProcessEnv(t,i);this.backup.clear(),this.environment.clear(),this.cwdOverride=void 0,this.updateWatchers(e)}updateProcessEnv(e,t){t==null?delete process.env[e]:process.env[e]=t}updateTerminalEnv(e,t){t===null&&this.backup.get(e)===void 0?this.environment.delete(e):this.environment.replace(e,t??"")}async load(){await this.try(async()=>{await U(),this.willLoad.fire()})}async try(e){try{await e()}catch(t){this.failed.fire(t)}}async onWillLoad(){this.blockedPath=void 0,this.status.update(d.loading);try{let e=await J(this.cwdOverride);this.didLoad.fire(e)}catch(e){e instanceof m&&this.blocked.fire(e)}}async onDidLoad(e){this.updateEnvironment(e),await this.updateCache(),this.loaded.fire(),![...e.keys()].every(b)&&this.didUpdate.fire()}onLoaded(){let e=d.empty;if(this.backup.size){let t=0,i=0,a=0;for(let[o,h]of this.backup){if(b(o))continue;h===void 0?(t+=1,this.output.appendLine(`added: ${o}`)):o in process.env?(i+=1,this.output.appendLine(`changed: ${o}`)):(a+=1,this.output.appendLine(`removed: ${o}`)),h&&this.output.appendLine(`was: ${h}`);let D=process.env[o];D&&this.output.appendLine(`now: ${D}`)}e=d.loaded({added:t,changed:i,removed:a,currentFolder:this.cwdOverride})}this.status.update(e)}async onFailed(e){if(this.status.update(d.failed),e instanceof v){let i=["Install","Configure"],a=await r.default.window.showErrorMessage(`direnv error: ${e.message}`,...i);a==="Install"&&await r.default.env.openExternal(de),a==="Configure"&&await s.path.executable.open();return}let t=ce(e);t!==void 0&&await r.default.window.showErrorMessage(`direnv error: ${t}`)}async onBlocked(e){this.blockedPath=e.path,this.resetEnvironment(e.data),await this.resetCache(),this.status.update(d.blocked(e.path));let t=["Allow","View"],i=await r.default.window.showWarningMessage(`direnv: ${e.path} is blocked`,...t);i==="Allow"&&await this.allow(e.path),i==="View"&&await this.open(e.path)}async onViewBlocked(e){await r.default.window.showInformationMessage(`direnv: Allow ${e}?`,"Allow")==="Allow"&&await this.allow(e)}async onDidUpdate(){await this.shouldRestart()&&(r.default.env.remoteName===void 0?await r.default.commands.executeCommand("workbench.action.restartExtensionHost"):await r.default.commands.executeCommand("workbench.action.reloadWindow"))}async shouldRestart(){return s.restart.automatic.get()?!0:await r.default.window.showWarningMessage("direnv: Environment updated. Restart extensions?","Restart")==="Restart"}};function ce(n){if(typeof n=="string")return n;if(n instanceof Error)return n.message;console.error("unhandled error",n)}async function ue(n){let e=r.default.Uri.file(n);try{return await r.default.workspace.fs.stat(e),e}catch{return e.with({scheme:"untitled"})}}function pe(n){let e=new E(r.default.window.createStatusBarItem()),t=new x(n,e);n.subscriptions.push(t),n.subscriptions.push(r.default.commands.registerCommand("direnv.reload",async()=>{await t.reload()}),r.default.commands.registerCommand("direnv.reset",async()=>{await t.reset()}),r.default.commands.registerCommand("direnv.allow",async()=>{var a;let i=(a=r.default.window.activeTextEditor)==null?void 0:a.document.fileName;i!==void 0&&await t.allow(i)}),r.default.commands.registerCommand("direnv.block",async()=>{var a;let i=(a=r.default.window.activeTextEditor)==null?void 0:a.document.fileName;i!==void 0&&await t.block(i)}),r.default.commands.registerCommand("direnv.create",async()=>{await t.create()}),r.default.commands.registerCommand("direnv.open",async()=>{await t.open()}),r.default.commands.registerCommand("direnv.loadEnvrc",async i=>{await t.loadEnvrc(i)}),r.default.window.tabGroups.onDidChangeTabs(i=>{for(let a of i.opened)a.input instanceof r.default.TabInputText&&t.didOpen(a.input.uri.path)}),r.default.workspace.onDidOpenTextDocument(i=>{t.didOpen(i.fileName)}),r.default.workspace.onDidChangeConfiguration(async i=>{await t.configurationChanged(i)})),t.restore()}function he(){}0&&(module.exports={activate,deactivate});
